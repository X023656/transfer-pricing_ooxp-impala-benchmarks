DROP TABLE IF EXISTS ooxp_datalocator_stages;

DROP TABLE IF EXISTS ooxp_datalocators;

CREATE TABLE IF NOT EXISTS ooxp_datalocators
(
    namespace              character varying(20) NOT NULL,
    -- This value helps identify where orginal data came from (e.g. DEV/CI/QA/SAT/PROD)
    client_id              character(3)           NOT NULL,
    -- 3-digit Lonestar Client ID, part of RLS
    tenant_id              integer                NOT NULL,
    -- link to ooxp_tenant_info.ooxp_tenants.id, part of RLS
    instance_id            character varying(255) NOT NULL,
    -- link to ooxp_tenant_info.ooxp_client_instances.instance_id; used as part of RLS
    id                     bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    task_id                uuid,
    -- reference (FK) to parent task in dep_task_queue
    version_name           character varying(50),
    -- version name, e.g. ACTUAL, etc
    record_count           bigint,
    generation_id          uuid,
    refreshed_date         timestamp without time zone,
    refreshed_by           jsonb,
    created_date           timestamp without time zone DEFAULT timezone('utc' :: text, now()),
    -- when was this created
    created_by             jsonb,
    -- and who did it
    last_updated_date      timestamp without time zone DEFAULT timezone('utc' :: text, now()),
    -- when was this value updated last time
    last_updated_by        jsonb,
    -- and who did it
    file_name              character varying(255),
    version_names          jsonb[],
    copy_to_version_name   character varying(255),
    copy_to_version_id     uuid,
    version_id             character varying(50),
    flow_version           character varying(255),
    internal_periods       jsonb[],
    multi_period           boolean,
    period                 integer                NOT NULL,
    -- YYYYMM, i.e. 201801, 201802...
    file_type              character varying(255),
    load_id                bigint                 NOT NULL,
    -- helps identify "stage group"
    definition_id          uuid                   NOT NULL,
    -- reference (FK) back to ooxp_definitions.id
    existing_datalocations jsonb[],
    current_stage          character varying(255),
    --ROWKEY, DEFINITION_VERSION_PERIOD_TIMESTAMP,
    internal_id            CHARACTER VARYING(100) NOT NULL,
    UNIQUE (definition_id, version_id, period, load_id)
--     CONSTRAINT fk_ooxp_datalocators_definition_id FOREIGN KEY (definition_id) REFERENCES ooxp_definitions (id) MATCH SIMPLE ON UPDATE NO ACTION ON DELETE NO ACTION,
--     CONSTRAINT fk_ooxp_datalocators_task_id FOREIGN KEY (task_id) REFERENCES public.ooxp_task_queue (id) MATCH SIMPLE ON UPDATE NO ACTION ON DELETE NO ACTION
);

CREATE INDEX IF NOT EXISTS ix_ooxp_datalocators_rls ON ooxp_datalocators USING btree (client_id, tenant_id, load_id);

CREATE INDEX IF NOT EXISTS ixu_ooxp_datalocators_iid ON ooxp_datalocators USING btree (internal_id);

CREATE UNIQUE INDEX IF NOT EXISTS ixu_ooxp_datalocators ON ooxp_datalocators USING btree (definition_id, version_id, period, load_id);

CREATE TABLE IF NOT EXISTS ooxp_datalocator_stages
(
    namespace                        character varying(20) NOT NULL,
    -- This value helps identify where orginal data came from (e.g. DEV/CI/QA/SAT/PROD)
    client_id                        character(3)           NOT NULL,
    -- 3-digit Lonestar Client ID, part of RLS
    tenant_id                        integer                NOT NULL,
    -- link to ooxp_tenant_info.ooxp_tenants.id, part of RLS
    instance_id                      character varying(255) NOT NULL,
    -- link to ooxp_tenant_info.ooxp_client_instances.instance_id; used as part of RLS
    id                               bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    datalocator_id                   bigint                 NOT NULL,
    task_id                          uuid,
    stage                            character varying(20)  NOT NULL,
    -- 'Arrived', 'PreReportReady', 'Imported', 'PostReportReady', 'Adjustment'
    stage_name                       character varying(50),
    -- this is for story PostReportReady_251779222203220 column info hbase
    post_report_ready_stage_executed boolean                NOT NULL DEFAULT false,
    protocol                         character varying(50),
    version_id                       character varying(50),
    version_name                     character varying(50),
    internal_periods                 jsonb[],
    --'hdfs://',aws
    folder                           character varying(255),
    file                             character varying(255),
    full_path                        character varying(1024),
    table_name                       character varying(255),
    fiscal_year                      int                    NOT NULL,
    fiscal_period                    int                    NOT NULL,
    total_records                    bigint,
    potentially_obsolete             boolean                NOT NULL DEFAULT false,
    visible                          boolean                NOT NULL DEFAULT false,
    --ROWKEY, DEFINITION_VERSION_PERIOD_TIMESTAMP,
    internal_id                      CHARACTER VARYING(100) NOT NULL,
    refreshed_date                   timestamp without time zone,
    refreshed_by                     jsonb,
    created_date                     timestamp without time zone     DEFAULT timezone('utc' :: text, now()),
    -- when was this created
    created_by                       jsonb,
    -- and who did it
    last_updated_date                timestamp without time zone     DEFAULT timezone('utc' :: text, now()),
    -- when was this value updated last time
    last_updated_by                  jsonb,
    -- helps identify "stage group",
    table_structure                  jsonb,
    domain                           CHARACTER VARYING(100),
    UNIQUE (stage, internal_id, datalocator_id)
--     CONSTRAINT fk_ooxp_datalocator_stages_datalocator_id FOREIGN KEY (datalocator_id) REFERENCES ooxp_datalocators (id) MATCH SIMPLE ON UPDATE NO ACTION ON DELETE NO ACTION,
--     CONSTRAINT fk_ooxp_datalocator_stages_task_id FOREIGN KEY (task_id) REFERENCES ooxp_task_queue (id) MATCH SIMPLE ON UPDATE NO ACTION ON DELETE NO ACTION
);

CREATE INDEX IF NOT EXISTS ix_ooxp_datalocator_stages_rls ON ooxp_datalocator_stages USING btree (client_id, tenant_id, instance_id);

CREATE UNIQUE INDEX IF NOT EXISTS ixu_ooxp_datalocator_stages ON ooxp_datalocator_stages USING btree (id, stage, internal_id);

CREATE UNIQUE INDEX IF NOT EXISTS ixu_ooxp_datalocator_stages_iid ON ooxp_datalocator_stages USING btree (internal_id);

CREATE SEQUENCE hibernate_sequence MINVALUE 1 MAXVALUE 1000000 START WITH 1 INCREMENT BY 1 CACHE 100;